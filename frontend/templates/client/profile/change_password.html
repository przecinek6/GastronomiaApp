{% extends "base.html" %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
<section class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Back to Profile -->
        <div class="mb-6">
            <a href="{% url 'client_profile' %}" 
               class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Powrót do profilu
            </a>
        </div>

        <!-- Header -->
        <div class="mb-8 text-center">
            <div class="w-16 h-16 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8 text-white"></i>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ title }}</h1>
            <p class="text-gray-600">Zwiększ bezpieczeństwo swojego konta zmieniając hasło</p>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-700{% elif message.tags == 'success' %}bg-green-50 border-green-200 text-green-700{% else %}bg-blue-50 border-blue-200 text-blue-700{% endif %} border rounded-lg p-4 mb-4">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Form -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="p-8">
                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- Current Password -->
                    <div>
                        <label for="{{ form.old_password.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            {{ form.old_password.label }} *
                        </label>
                        {{ form.old_password }}
                        {% if form.old_password.errors %}
                            <div class="text-red-500 text-sm mt-1">
                                {{ form.old_password.errors.0 }}
                            </div>
                        {% endif %}
                        <p class="text-gray-500 text-sm mt-1">Wprowadź swoje obecne hasło aby potwierdzić tożsamość</p>
                    </div>

                    <!-- New Password -->
                    <div>
                        <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            {{ form.new_password1.label }} *
                        </label>
                        {{ form.new_password1 }}
                        {% if form.new_password1.errors %}
                            <div class="text-red-500 text-sm mt-1">
                                {{ form.new_password1.errors.0 }}
                            </div>
                        {% endif %}
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                                <span id="password-strength-text" class="text-sm font-medium text-gray-500">Bardzo słabe</span>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div>
                        <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-semibold text-gray-700 mb-2">
                            {{ form.new_password2.label }} *
                        </label>
                        {{ form.new_password2 }}
                        {% if form.new_password2.errors %}
                            <div class="text-red-500 text-sm mt-1">
                                {{ form.new_password2.errors.0 }}
                            </div>
                        {% endif %}
                        <p class="text-gray-500 text-sm mt-1">Powtórz nowe hasło aby potwierdzić</p>
                    </div>

                    <!-- Password Requirements -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h4 class="text-sm font-semibold text-blue-800 mb-2 flex items-center">
                            <i data-lucide="info" class="w-4 h-4 mr-1"></i>
                            Wymagania dotyczące hasła
                        </h4>
                        <ul class="text-sm text-blue-700 space-y-1">
                            <li class="flex items-center">
                                <i data-lucide="check" class="w-3 h-3 mr-2 text-blue-600"></i>
                                Minimum 8 znaków
                            </li>
                            <li class="flex items-center">
                                <i data-lucide="check" class="w-3 h-3 mr-2 text-blue-600"></i>
                                Przynajmniej jedna wielka litera
                            </li>
                            <li class="flex items-center">
                                <i data-lucide="check" class="w-3 h-3 mr-2 text-blue-600"></i>
                                Przynajmniej jedna mała litera
                            </li>
                            <li class="flex items-center">
                                <i data-lucide="check" class="w-3 h-3 mr-2 text-blue-600"></i>
                                Przynajmniej jedna cyfra
                            </li>
                            <li class="flex items-center">
                                <i data-lucide="check" class="w-3 h-3 mr-2 text-blue-600"></i>
                                Znak specjalny (np. !@#$%^&*)
                            </li>
                        </ul>
                    </div>

                    <!-- Form Buttons -->
                    <div class="border-t pt-6">
                        <div class="flex flex-col sm:flex-row gap-4 justify-end">
                            <a href="{% url 'client_profile' %}" 
                               class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-center">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Anuluj
                            </a>
                            <button type="submit" 
                                    class="px-8 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-lg font-semibold hover:from-blue-600 hover:to-purple-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i data-lucide="key" class="w-4 h-4 inline mr-2"></i>
                                Zmień hasło
                            </button>
                        </div>
                    </div>

                    <!-- Non-field errors -->
                    {% if form.non_field_errors %}
                        <div class="text-red-500 text-sm">
                            {{ form.non_field_errors.0 }}
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>

        <!-- Security Tips -->
        <div class="mt-8 bg-yellow-50 border border-yellow-200 rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-yellow-800 mb-3 flex items-center">
                <i data-lucide="lightbulb" class="w-5 h-5 mr-2"></i>
                Wskazówki bezpieczeństwa
            </h3>
            <ul class="space-y-2 text-yellow-700">
                <li class="flex items-start">
                    <i data-lucide="shield" class="w-4 h-4 mr-2 mt-0.5 text-yellow-600"></i>
                    <span>Używaj unikalnego hasła dla każdego konta</span>
                </li>
                <li class="flex items-start">
                    <i data-lucide="shield" class="w-4 h-4 mr-2 mt-0.5 text-yellow-600"></i>
                    <span>Rozważ użycie menedżera haseł</span>
                </li>
                <li class="flex items-start">
                    <i data-lucide="shield" class="w-4 h-4 mr-2 mt-0.5 text-yellow-600"></i>
                    <span>Zmieniaj hasło regularnie (co 3-6 miesięcy)</span>
                </li>
                <li class="flex items-start">
                    <i data-lucide="shield" class="w-4 h-4 mr-2 mt-0.5 text-yellow-600"></i>
                    <span>Nigdy nie udostępniaj swojego hasła innym osobom</span>
                </li>
            </ul>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
    
    // Password strength checker
    const passwordInput = document.getElementById('{{ form.new_password1.id_for_label }}');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('password-strength-text');
    
    if (passwordInput) {
        passwordInput.addEventListener('input', function() {
            const password = this.value;
            const strength = calculatePasswordStrength(password);
            updatePasswordStrengthUI(strength);
        });
    }
    
    function calculatePasswordStrength(password) {
        let score = 0;
        
        // Length check
        if (password.length >= 8) score += 1;
        if (password.length >= 12) score += 1;
        
        // Character variety
        if (/[a-z]/.test(password)) score += 1;
        if (/[A-Z]/.test(password)) score += 1;
        if (/[0-9]/.test(password)) score += 1;
        if (/[^A-Za-z0-9]/.test(password)) score += 1;
        
        return Math.min(score, 5);
    }
    
    function updatePasswordStrengthUI(strength) {
        const colors = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#16a34a'];
        const texts = ['Bardzo słabe', 'Słabe', 'Średnie', 'Dobre', 'Bardzo silne'];
        const widths = [20, 40, 60, 80, 100];
        
        if (strength === 0) {
            strengthBar.style.width = '0%';
            strengthBar.style.backgroundColor = '#e5e7eb';
            strengthText.textContent = 'Bardzo słabe';
            strengthText.className = 'text-sm font-medium text-gray-500';
        } else {
            strengthBar.style.width = widths[strength - 1] + '%';
            strengthBar.style.backgroundColor = colors[strength - 1];
            strengthText.textContent = texts[strength - 1];
            
            if (strength <= 2) {
                strengthText.className = 'text-sm font-medium text-red-600';
            } else if (strength === 3) {
                strengthText.className = 'text-sm font-medium text-yellow-600';
            } else {
                strengthText.className = 'text-sm font-medium text-green-600';
            }
        }
    }
    
    // Focus on first field
    const firstField = document.querySelector('input[type="password"]');
    if (firstField) {
        firstField.focus();
    }
});
</script>
{% endblock content %}