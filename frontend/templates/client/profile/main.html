{% extends "base.html" %}
{% load dish_filters %}

{% block title %}Profil użytkownika{% endblock title %}

{% block content %}
<section class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Back to Dashboard -->
        <div class="mb-6">
            <a href="{% url 'client_dashboard' %}" 
               class="inline-flex items-center text-gray-600 hover:text-gray-800 transition-colors">
                <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                Powrót do dashboardu
            </a>
        </div>

        <!-- Header -->
        <div class="mb-8 text-center">
            <div class="w-20 h-20 bg-gradient-to-r from-green-400 to-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="text-white font-bold text-2xl">{{ user.first_name.0|default:user.username.0|upper }}</span>
            </div>
            <h1 class="text-4xl font-bold text-gray-800 mb-2">{{ user.first_name }} {{ user.last_name }}</h1>
            <p class="text-gray-600">{{ user.email }}</p>
        </div>

        <!-- Messages -->
        {% if messages %}
            <div class="mb-6">
                {% for message in messages %}
                    <div class="{% if message.tags == 'error' %}bg-red-50 border-red-200 text-red-700{% elif message.tags == 'success' %}bg-green-50 border-green-200 text-green-700{% else %}bg-blue-50 border-blue-200 text-blue-700{% endif %} border rounded-lg p-4 mb-4">
                        {{ message }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Personal Data Section -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden mb-8">
            <div class="p-8">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center">
                        <i data-lucide="user" class="w-6 h-6 mr-3 text-green-600"></i>
                        Dane osobowe
                    </h2>
                    <button id="edit-button" 
                            onclick="toggleEdit()" 
                            class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                        <i data-lucide="edit" class="w-4 h-4 inline mr-2"></i>
                        <span id="edit-text">Edytuj</span>
                    </button>
                </div>

                <form id="profile-form" method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- First Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Imię</label>
                            <div id="first_name_display" class="display-field">
                                <p class="text-gray-800 text-lg">{{ user.first_name|default:"Nie podano" }}</p>
                            </div>
                            <div id="first_name_edit" class="edit-field hidden">
                                <input type="text" 
                                       name="first_name" 
                                       value="{{ user.first_name }}" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors"
                                       placeholder="Twoje imię">
                            </div>
                        </div>

                        <!-- Last Name -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Nazwisko</label>
                            <div id="last_name_display" class="display-field">
                                <p class="text-gray-800 text-lg">{{ user.last_name|default:"Nie podano" }}</p>
                            </div>
                            <div id="last_name_edit" class="edit-field hidden">
                                <input type="text" 
                                       name="last_name" 
                                       value="{{ user.last_name }}" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors"
                                       placeholder="Twoje nazwisko">
                            </div>
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Adres email</label>
                            <div id="email_display" class="display-field">
                                <p class="text-gray-800 text-lg">{{ user.email }}</p>
                            </div>
                            <div id="email_edit" class="edit-field hidden">
                                <input type="email" 
                                       name="email" 
                                       value="{{ user.email }}" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors"
                                       placeholder="Twój adres email">
                            </div>
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Numer telefonu</label>
                            <div id="phone_display" class="display-field">
                                <p class="text-gray-800 text-lg">{{ profile.phone|default:"Nie podano" }}</p>
                            </div>
                            <div id="phone_edit" class="edit-field hidden">
                                <input type="tel" 
                                       name="phone" 
                                       value="{{ profile.phone }}" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors"
                                       placeholder="Numer telefonu">
                            </div>
                        </div>

                        <!-- Date of Birth -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Data urodzenia</label>
                            <div id="date_of_birth_display" class="display-field">
                                <p class="text-gray-800 text-lg">{{ profile.date_of_birth|date:"d.m.Y"|default:"Nie podano" }}</p>
                            </div>
                            <div id="date_of_birth_edit" class="edit-field hidden">
                                <input type="date" 
                                       name="date_of_birth" 
                                       value="{{ profile.date_of_birth|date:'Y-m-d' }}" 
                                       class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors">
                            </div>
                        </div>

                        <!-- Member Since -->
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Członek od</label>
                            <div class="display-field">
                                <p class="text-gray-800 text-lg">{{ user.date_joined|date:"d.m.Y" }}</p>
                            </div>
                        </div>
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Adres zamieszkania</label>
                        <div id="address_display" class="display-field">
                            <p class="text-gray-800 text-lg">{{ profile.address|default:"Nie podano" }}</p>
                        </div>
                        <div id="address_edit" class="edit-field hidden">
                            <textarea name="address" 
                                      rows="3"
                                      class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:border-green-500 focus:outline-none transition-colors resize-none"
                                      placeholder="Twój adres zamieszkania">{{ profile.address }}</textarea>
                        </div>
                    </div>

                    <!-- Action Buttons (hidden by default) -->
                    <div id="form-actions" class="hidden border-t pt-6">
                        <div class="flex flex-col sm:flex-row gap-4 justify-end">
                            <button type="button" 
                                    onclick="cancelEdit()" 
                                    class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                                <i data-lucide="x" class="w-4 h-4 inline mr-2"></i>
                                Anuluj
                            </button>
                            <button type="submit" 
                                    class="px-8 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg font-semibold hover:from-green-600 hover:to-green-700 transition-all duration-200 shadow-lg hover:shadow-xl">
                                <i data-lucide="save" class="w-4 h-4 inline mr-2"></i>
                                Zapisz zmiany
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Quick Links -->
        <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-xl font-bold text-gray-800">Dodatkowe ustawienia</h3>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    
                    <a href="{% url 'profile_change_password' %}" 
                       class="flex flex-col items-center p-6 bg-blue-50 hover:bg-blue-100 rounded-xl transition-colors text-center">
                        <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="lock" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-semibold text-gray-800 mb-1">Bezpieczeństwo</h4>
                        <p class="text-sm text-gray-600">Zmień hasło</p>
                    </a>

                    <a href="{% url 'profile_delivery_address' %}" 
                       class="flex flex-col items-center p-6 bg-green-50 hover:bg-green-100 rounded-xl transition-colors text-center">
                        <div class="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="map-pin" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-semibold text-gray-800 mb-1">Adresy dostawy</h4>
                        <p class="text-sm text-gray-600">Zarządzaj adresami</p>
                    </a>

                    <a href="{% url 'profile_notifications' %}" 
                       class="flex flex-col items-center p-6 bg-purple-50 hover:bg-purple-100 rounded-xl transition-colors text-center">
                        <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="bell" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-semibold text-gray-800 mb-1">Powiadomienia</h4>
                        <p class="text-sm text-gray-600">Ustaw preferencje</p>
                    </a>

                    <a href="{% url 'profile_delete_account' %}" 
                       class="flex flex-col items-center p-6 bg-red-50 hover:bg-red-100 rounded-xl transition-colors text-center">
                        <div class="w-12 h-12 bg-red-500 rounded-full flex items-center justify-center mb-3">
                            <i data-lucide="trash-2" class="w-6 h-6 text-white"></i>
                        </div>
                        <h4 class="font-semibold text-gray-800 mb-1">Usuń konto</h4>
                        <p class="text-sm text-gray-600">Dezaktywuj konto</p>
                    </a>
                    
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
});

let isEditing = false;

function toggleEdit() {
    isEditing = !isEditing;
    
    const displayFields = document.querySelectorAll('.display-field');
    const editFields = document.querySelectorAll('.edit-field');
    const formActions = document.getElementById('form-actions');
    const editButton = document.getElementById('edit-button');
    const editText = document.getElementById('edit-text');
    
    if (isEditing) {
        // Switch to edit mode
        displayFields.forEach(field => field.classList.add('hidden'));
        editFields.forEach(field => field.classList.remove('hidden'));
        formActions.classList.remove('hidden');
        editButton.innerHTML = '<i data-lucide="x" class="w-4 h-4 inline mr-2"></i><span>Anuluj</span>';
        editButton.className = 'bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors';
        
        // Focus on first input
        const firstInput = document.querySelector('.edit-field input');
        if (firstInput) firstInput.focus();
        
    } else {
        // Switch to display mode
        displayFields.forEach(field => field.classList.remove('hidden'));
        editFields.forEach(field => field.classList.add('hidden'));
        formActions.classList.add('hidden');
        editButton.innerHTML = '<i data-lucide="edit" class="w-4 h-4 inline mr-2"></i><span>Edytuj</span>';
        editButton.className = 'bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors';
    }
    
    // Re-initialize Lucide icons
    lucide.createIcons();
}

function cancelEdit() {
    // Reset form to original values
    document.getElementById('profile-form').reset();
    
    // Switch back to display mode
    isEditing = true; // Set to true so toggleEdit() will switch to false
    toggleEdit();
}

// Handle form submission
document.getElementById('profile-form').addEventListener('submit', function(e) {
    // Form will submit normally, but we can add validation here if needed
    const submitButton = this.querySelector('button[type="submit"]');
    submitButton.innerHTML = '<i data-lucide="loader" class="w-4 h-4 inline mr-2 animate-spin"></i>Zapisywanie...';
    submitButton.disabled = true;
});
</script>
{% endblock content %}